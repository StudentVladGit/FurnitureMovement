@page "/counter"
@using FurnitureMovement.Data
@using FurnitureMovement.Services
@using Blazorise
@using Blazorise.DataGrid
@using Blazorise.Icons
@inject IOrderService OrderService

<PageTitle>ТАБЛИЦА</PageTitle>

<h1>ТАБЛИЦА ОСНАСТКИ</h1>

<!-- Кнопка "Добавить" -->
<Button Color="Color.Primary" @onclick="ShowAddModal">Добавить</Button>

@if (orders == null)
{
    <p>Загрузка данных...</p>
}
else
{
    <DataGrid TItem="Order"
              Data="@orders"
              ShowPager="true">
        <DataGridColumns>
            <DataGridColumn TItem="Order" Field="@nameof(Order.ID)" Caption="ID" />
            <DataGridColumn TItem="Order" Field="@nameof(Order.OrderNumber)" Caption="Номер" />
            <DataGridColumn TItem="Order" Field="@nameof(Order.OrderName)" Caption="Наименование" />
            <DataGridColumn TItem="Order" Caption="Количество">
                <DisplayTemplate Context="order">
                    @(order.Orders?.FirstOrDefault()?.OrderQuantity.ToString() ?? "0")
                </DisplayTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="Order" Caption="Статус">
                <DisplayTemplate Context="order">
                    @(order.Orders?.FirstOrDefault()?.OrderStatus.ToString() ?? "0")
                </DisplayTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="Order" Caption="Дата">
                <DisplayTemplate Context="order">
                    @(order.Orders?.FirstOrDefault()?.AdmissionDate.ToString("dd/MM/yyyy") ?? "")
                </DisplayTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="Order" Caption="Автор">
                <DisplayTemplate Context="order">
                    @(order.Orders?.FirstOrDefault()?.OrderAuthor ?? "")
                </DisplayTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="Order" Caption="Действия" Sortable="false">
                <DisplayTemplate>
                    <Button Color="Color.Primary" Size="Size.Small">
                        //Тут Должна быть кнопка
                    </Button>
                    <Button Color="Color.Danger" Size="Size.Small" class="ml-3">
                        //Тут Должна быть кнопка
                    </Button>
                </DisplayTemplate>
            </DataGridColumn>
        </DataGridColumns>
    </DataGrid>
}

<Modal @ref="addModal">
    <ModalContent>
        <ModalHeader>
            <ModalTitle>Добавить новый заказ</ModalTitle>
            <CloseButton @onclick="HideAddModal" />
        </ModalHeader>
        <ModalBody>
            <!-- Поля для ввода данных -->
            <Field>
                <FieldLabel>Номер заказа</FieldLabel>
                <TextEdit @bind-Text="newOrder.OrderNumber" />
            </Field>
            <Field>
                <FieldLabel>Наименование</FieldLabel>
                <TextEdit @bind-Text="newOrder.OrderName" />
            </Field>
            <Field>
                <FieldLabel>Количество</FieldLabel>
                <NumericEdit TValue="long" @bind-Value="newOrderFurniture.OrderQuantity" />
            </Field>
            <Field>
                <FieldLabel>Статус</FieldLabel>
                <Select TValue="OrderStatus" @bind-SelectedValue="newOrderFurniture.OrderStatus">
                    @foreach (OrderStatus status in Enum.GetValues(typeof(OrderStatus)))
                    {
                        <SelectItem TValue="OrderStatus" Value="@status">@status.ToString()</SelectItem>
                    }
                </Select>
            </Field>
            <Field>
                <FieldLabel>Дата</FieldLabel>
                <DateEdit @bind-Date="newOrderFurniture.AdmissionDate" />
            </Field>
            <Field>
                <FieldLabel>Автор</FieldLabel>
                <TextEdit @bind-Text="newOrderFurniture.OrderAuthor" />
            </Field>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" @onclick="HideAddModal">Отмена</Button>
            <Button Color="Color.Primary" @onclick="SaveOrder">Сохранить</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@code {
    private Modal addModal;
    private List<Order> orders = new();
    private int totalOrders;
    private Order newOrder = new();
    private OrderFurniture newOrderFurniture = new()
    {
        OrderStatus = OrderStatus.Generated,
        AdmissionDate = DateTime.Today,
        OrderQuantity = 1
    };

    protected override async Task OnInitializedAsync()
    {
        await Refresh();
    }

    private void ShowAddModal()
    {
        newOrder = new Order();
        newOrderFurniture = new OrderFurniture
        {
            OrderStatus = OrderStatus.Generated,
            AdmissionDate = DateTime.Today,
            OrderQuantity = 1
        };
        addModal.Show();
    }

    private void HideAddModal()
    {
        addModal.Hide();
    }

    private async Task SaveOrder()
    {
        newOrder.Orders = new List<OrderFurniture> { newOrderFurniture };
        newOrderFurniture.Order = newOrder;

        await OrderService.CreateOrder(newOrder, newOrderFurniture);
        await Refresh();
        addModal.Hide();
    }

    private void EditItem(Order order)
    {
        // Пустая реализация (заглушка)
    }

    private void DeleteItem(Order order)
    {
        // Пустая реализация (заглушка)
    }

    private async Task Refresh()
    {
        orders = await OrderService.GetAllOrders();
        StateHasChanged();
    }
}