@page "/FurnitureTable"
@using FurnitureMovement.Data
@using FurnitureMovement.Services
@using Blazorise
@using Blazorise.DataGrid
@using Blazorise.Icons.FontAwesome
@inject IJSRuntime JSRuntime
@inject IOrderService OrderService

<PageTitle>Список оснастки</PageTitle>

<h3>Таблица списка оснастки</h3>

<Button Color="Color.Primary" @onclick="ShowAddModal">Добавить оснастку</Button>

<DataGrid TItem="FurnitureName"
          Data="@FurnitureNames"
          ShowPager="true"
          PageSize="10">
    <DataGridColumns>
        <DataGridColumn TItem="FurnitureName" Field="@nameof(FurnitureName.ID)" Caption="ID" />
        <DataGridColumn TItem="FurnitureName" Field="@nameof(FurnitureName.Name)" Caption="Наименование" />
        <DataGridColumn TItem="FurnitureName" Caption="Действия" Sortable="false">
            <DisplayTemplate Context="name">
                <div class="d-flex justify-content-end gap-2">
                    <Button Color="Color.Primary" Size="Size.Small" @onclick="() => EditName(name)">
                        ✏️
                    </Button>
                    <Button Color="Color.Danger" Size="Size.Small" @onclick="() => DeleteName(name)">
                        🗑️
                    </Button>
                </div>
            </DisplayTemplate>
        </DataGridColumn>
    </DataGridColumns>
</DataGrid>

<!-- Модальное окно добавления -->
<Modal @ref="addModalRef">
    <ModalContent>
        <ModalHeader>
            <ModalTitle>@(isEditing ? "Редактировать" : "Добавить") оснастку</ModalTitle>
            <CloseButton @onclick="HideAddModal" />
        </ModalHeader>
        <ModalBody>
            <Field>
                <FieldLabel>Наименование оснастки</FieldLabel>
                <TextEdit @bind-Text="currentFurnitureName.Name" />
            </Field>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" @onclick="HideAddModal">Отмена</Button>
            <Button Color="Color.Primary" @onclick="SaveFurnitureName">Сохранить</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@code {
    private Modal addModalRef = new Modal();
    private List<FurnitureName> FurnitureNames = new();
    private FurnitureName currentFurnitureName = new();
    private bool isEditing = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadFurnitureNames();
    }

    private async Task LoadFurnitureNames()
    {
        FurnitureNames = await OrderService.GetAllFurnitureNames();
        StateHasChanged();
    }

    private void ShowAddModal()
    {
        currentFurnitureName = new FurnitureName();
        isEditing = false;
        addModalRef.Show();
    }

    private void HideAddModal()
    {
        addModalRef.Hide();
    }

    private async Task SaveFurnitureName()
    {
        if (string.IsNullOrWhiteSpace(currentFurnitureName.Name))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Наименование не может быть пустым!");
            return;
        }

        try
        {
            if (isEditing)
            {
                await OrderService.UpdateFurnitureName(currentFurnitureName);
            }
            else
            {
                await OrderService.AddFurnitureName(currentFurnitureName);
            }

            await LoadFurnitureNames();
            addModalRef.Hide();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", ex.Message);
        }
    }

    private void EditName(FurnitureName name)
    {
        currentFurnitureName = new FurnitureName { ID = name.ID, Name = name.Name };
        isEditing = true;
        addModalRef.Show();
    }

    private async Task DeleteName(FurnitureName name)
    {
        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"Удалить оснастку {name.Name}?");
        if (!confirm) return;

        try
        {
            await OrderService.DeleteFurnitureName(name.ID);
            await LoadFurnitureNames();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", ex.Message);
        }
    }
}